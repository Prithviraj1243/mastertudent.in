<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Document Viewer - Student Notes Marketplace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .document-info {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .document-info h2 {
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: #1f2937;
        }

        .actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .viewer-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .viewer-header {
            background: #f9fafb;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .file-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .file-tab {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .file-tab.active {
            background: #2563eb;
            color: white;
        }

        .document-viewer {
            min-height: 600px;
            padding: 1rem;
        }

        .pdf-viewer {
            width: 100%;
            height: 800px;
            border: none;
        }

        .image-viewer {
            text-align: center;
        }

        .image-viewer img {
            max-width: 100%;
            max-height: 800px;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .text-viewer {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }

        .file-list {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-icon {
            font-size: 1.5rem;
        }

        .file-details h4 {
            margin-bottom: 0.25rem;
            color: #1f2937;
        }

        .file-meta {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .success {
            background: #f0fdf4;
            color: #16a34a;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÑ Admin Document Viewer</h1>
    </div>

    <div class="container">
        <!-- Document Information -->
        <div class="document-info">
            <h2>Document Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Note Title</span>
                    <span class="info-value" id="noteTitle">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Subject</span>
                    <span class="info-value" id="noteSubject">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Author</span>
                    <span class="info-value" id="noteAuthor">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status</span>
                    <span class="info-value" id="noteStatus">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Upload Date</span>
                    <span class="info-value" id="uploadDate">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total Files</span>
                    <span class="info-value" id="totalFiles">Loading...</span>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="approveNote()">‚úÖ Approve Note</button>
                <button class="btn btn-secondary" onclick="rejectNote()">‚ùå Reject Note</button>
                <a href="#" class="btn btn-secondary" id="backLink">‚Üê Back to Admin Panel</a>
            </div>
        </div>

        <!-- File List -->
        <div class="file-list">
            <h3>üìÅ Attached Files</h3>
            <div id="filesList">
                <div class="loading">Loading files...</div>
            </div>
        </div>

        <!-- Document Viewer -->
        <div class="viewer-container">
            <div class="viewer-header">
                <h3>üìñ Document Viewer</h3>
                <div class="file-tabs" id="fileTabs">
                    <!-- File tabs will be populated here -->
                </div>
            </div>
            <div class="document-viewer" id="documentViewer">
                <div class="loading">Select a file to view</div>
            </div>
        </div>
    </div>

    <script>
        // Get note ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const noteId = urlParams.get('noteId');
        const adminToken = localStorage.getItem('adminToken');

        if (!noteId) {
            document.getElementById('documentViewer').innerHTML = '<div class="error">No note ID provided</div>';
        }

        if (!adminToken) {
            document.getElementById('documentViewer').innerHTML = '<div class="error">Admin authentication required</div>';
        }

        let currentNoteData = null;
        let currentFiles = [];

        // Load note files
        async function loadNoteFiles() {
            try {
                const response = await fetch(`/api/admin/notes/${noteId}/files`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load note files');
                }

                const data = await response.json();
                currentNoteData = data;
                currentFiles = data.files || [];

                // Update document information
                document.getElementById('noteTitle').textContent = data.noteTitle || 'Unknown';
                document.getElementById('noteSubject').textContent = data.noteSubject || 'Unknown';
                document.getElementById('noteAuthor').textContent = data.author?.name || 'Unknown';
                document.getElementById('noteStatus').textContent = data.noteStatus || 'Unknown';
                document.getElementById('uploadDate').textContent = new Date(data.uploadDate).toLocaleDateString();
                document.getElementById('totalFiles').textContent = data.totalFiles || 0;

                // Render files list
                renderFilesList();
                renderFileTabs();

                // Auto-select first file
                if (currentFiles.length > 0) {
                    viewFile(currentFiles[0]);
                }

            } catch (error) {
                console.error('Error loading note files:', error);
                document.getElementById('documentViewer').innerHTML = `<div class="error">Error loading files: ${error.message}</div>`;
            }
        }

        // Render files list
        function renderFilesList() {
            const filesList = document.getElementById('filesList');
            
            if (currentFiles.length === 0) {
                filesList.innerHTML = '<div class="loading">No files attached to this note</div>';
                return;
            }

            filesList.innerHTML = currentFiles.map(file => `
                <div class="file-item">
                    <div class="file-info">
                        <span class="file-icon">${file.icon}</span>
                        <div class="file-details">
                            <h4>${file.fileName}</h4>
                            <div class="file-meta">
                                ${file.fileType} ‚Ä¢ ${formatFileSize(file.fileSize)} ‚Ä¢ 
                                ${file.canPreview ? 'Can Preview' : 'Download Only'}
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        ${file.canPreview ? `<button class="btn btn-primary" onclick="viewFile(${JSON.stringify(file).replace(/"/g, '&quot;')})">üëÅÔ∏è Preview</button>` : ''}
                        <a href="${file.downloadUrl}" class="btn btn-secondary" target="_blank">‚¨áÔ∏è Download</a>
                    </div>
                </div>
            `).join('');
        }

        // Render file tabs
        function renderFileTabs() {
            const fileTabs = document.getElementById('fileTabs');
            
            if (currentFiles.length === 0) {
                fileTabs.innerHTML = '';
                return;
            }

            fileTabs.innerHTML = currentFiles.map((file, index) => `
                <button class="file-tab ${index === 0 ? 'active' : ''}" 
                        onclick="viewFile(${JSON.stringify(file).replace(/"/g, '&quot;')}); setActiveTab(this)">
                    ${file.icon} ${file.fileName}
                </button>
            `).join('');
        }

        // View file in the document viewer
        async function viewFile(file) {
            const viewer = document.getElementById('documentViewer');
            viewer.innerHTML = '<div class="loading">Loading file...</div>';

            try {
                if (file.fileType === 'image') {
                    viewer.innerHTML = `
                        <div class="image-viewer">
                            <img src="${file.previewUrl}" alt="${file.fileName}" />
                            <p><strong>${file.fileName}</strong> (${formatFileSize(file.fileSize)})</p>
                        </div>
                    `;
                } else if (file.fileExtension === 'pdf') {
                    viewer.innerHTML = `
                        <iframe class="pdf-viewer" src="${file.previewUrl}" type="application/pdf">
                            <p>Your browser doesn't support PDF viewing. <a href="${file.downloadUrl}">Download the PDF</a></p>
                        </iframe>
                    `;
                } else if (['txt', 'html', 'css', 'js', 'json'].includes(file.fileExtension)) {
                    // Load text content
                    const response = await fetch(file.previewUrl, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`,
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        viewer.innerHTML = `
                            <div class="text-viewer">${escapeHtml(data.content)}</div>
                            <p><strong>${file.fileName}</strong> (${formatFileSize(file.fileSize)})</p>
                        `;
                    } else {
                        throw new Error('Failed to load text content');
                    }
                } else {
                    viewer.innerHTML = `
                        <div class="loading">
                            <p>Preview not available for ${file.fileType} files</p>
                            <a href="${file.downloadUrl}" class="btn btn-primary">‚¨áÔ∏è Download ${file.fileName}</a>
                        </div>
                    `;
                }
            } catch (error) {
                viewer.innerHTML = `<div class="error">Error loading file: ${error.message}</div>`;
            }
        }

        // Set active tab
        function setActiveTab(clickedTab) {
            document.querySelectorAll('.file-tab').forEach(tab => tab.classList.remove('active'));
            clickedTab.classList.add('active');
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Admin actions
        async function approveNote() {
            if (!confirm('Are you sure you want to approve this note?')) return;
            
            try {
                const response = await fetch(`/api/admin/notes/${noteId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Note approved successfully!');
                    document.getElementById('noteStatus').textContent = 'approved';
                } else {
                    throw new Error('Failed to approve note');
                }
            } catch (error) {
                alert('Error approving note: ' + error.message);
            }
        }

        async function rejectNote() {
            const reason = prompt('Please provide a reason for rejection:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/admin/notes/${noteId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });

                if (response.ok) {
                    alert('Note rejected successfully!');
                    document.getElementById('noteStatus').textContent = 'rejected';
                } else {
                    throw new Error('Failed to reject note');
                }
            } catch (error) {
                alert('Error rejecting note: ' + error.message);
            }
        }

        // Initialize
        if (noteId && adminToken) {
            loadNoteFiles();
        }

        // Set back link
        document.getElementById('backLink').href = `http://localhost:3001/admin`;
    </script>
</body>
</html>
